---
import { getNotionTexts } from '../lib/notion';
import { notionDatabases } from '../lib/notionConfig';

const text = await getNotionTexts(notionDatabases.contacto);
---

<div class="cpragma-contact container">
    <div class="row-contact row">
        <div class="row-contact__col row-contact__col--txt">
            {text.slice().reverse().map((t) => (
                <div class="txt-top-section dark">
                    <span>{t.textTop}</span>
                </div>
                <div class="title-section dark">
                    <h2>{t.title} <span>{t.titlei}</span></h2>
                </div>
                <div class="info-contact row">
                    <div class="info-contact__col info-contact__col--address">
                        <h4>Dirección</h4>
                        <div class="address-row">
                            <div class="address-row__col">
                                <a href="https://maps.app.goo.gl/sVdsY5CaT74zfQfj6" target="_blank">
                                    <p>{t.direccionChile}</p>
                                </a>
                            </div>
                            <div class="address-row__col">
                                <a href="https://maps.app.goo.gl/rxv95NfdzT15g8dM9" target="_blank">
                                    <p>{t.direccionEspaña}</p>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="info-contact__col info-contact__col--contact">
                        <a href="mailto:contacto@cpragma.com">contacto@cpragma.com</a>
                        <a href="tel:56222354082">+56 2 2235 4082</a>
                    </div>
                </div>
            ))}
        </div>
        <div class="row-contact__col row-contact__col--form">
            <form id="contactForm">
                <div class="box-input">
                    <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
                </div>
                <div class="box-input">
                    <input type="text" id="empresa" name="empresa" placeholder="Empresa" required>
                </div>
                <div class="group-input">
                    <input type="tel" id="telefono" name="telefono" placeholder="Teléfono" required>
                    <input type="email" id="email" name="email" placeholder="Email" required>
                </div>
                <div class="box-input">
                    <textarea id="mensaje" name="mensaje" rows="5" placeholder="Mensaje" required></textarea>
                </div>
                <button class="btn-form" type="submit">Enviar</button>
            </form>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById("contactForm") as HTMLFormElement | null;
    
    form?.addEventListener("submit", async (e: SubmitEvent) => {
        e.preventDefault();
        const target = e.target as HTMLFormElement;
        const formData = new FormData(target);
        
        try {
            const res = await fetch("/api/send-mail", {
                method: "POST",
                body: formData,
            });
            
            const data = await res.json();
            
            if (res.ok) {
                alert("✅ Mensaje enviado correctamente");
                target.reset();
            } else {
                alert("❌ " + (data.error || "Error al enviar"));
            }
        } catch (err) {
            alert("❌ Hubo un error de conexión");
        }
    });
</script>