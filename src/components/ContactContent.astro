---
import { getNotionTexts } from '../lib/notion';
import { notionDatabases } from '../lib/notionConfig';

const text = await getNotionTexts(notionDatabases.contacto);
---

<div class="cpragma-contact container">
    <div class="row-contact row">
        <div class="row-contact__col row-contact__col--txt">
            {text.slice().reverse().map((t) => (
                <div class="txt-top-section dark">
                    <span>{t.textTop}</span>
                </div>
                <div class="title-section dark">
                    <h2>{t.title} <span>{t.titlei}</span></h2>
                </div>
                <div class="info-contact row">
                    <div class="info-contact__col info-contact__col--address">
                        <h4>Dirección</h4>
                        <div class="address-row">
                            <div class="address-row__col">
                                <a href="https://maps.app.goo.gl/sVdsY5CaT74zfQfj6" target="_blank">
                                    <p>{t.direccionChile}</p>
                                </a>
                            </div>
                            <div class="address-row__col">
                                <a href="https://maps.app.goo.gl/rxv95NfdzT15g8dM9" target="_blank">
                                    <p>{t.direccionEspaña}</p>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="info-contact__col info-contact__col--contact">
                        <a href="mailto:contacto@cpragma.com">contacto@cpragma.com</a>
                        <a href="tel:56222354082">+56 2 2235 4082</a>
                    </div>
                </div>
            ))}
        </div>
        <div class="row-contact__col row-contact__col--form">
            <form id="contact-form" action="https://api.web3forms.com/submit" method="POST">
                <input type="hidden" name="access_key" value="62d2d897-309e-4f14-9481-1dc2994e177d">
                <input type="hidden" name="subject" value="Nuevo mensaje cpragma.com">
                <input type="hidden" name="from_name" value="cpragma.com">
                <input type="checkbox" name="botcheck" class="hidden" style="display: none;">
                <div class="box-input">
                    <input type="text" name="nombre" placeholder="Nombre" required>
                </div>
                <div class="box-input">
                    <input type="text" name="empresa" placeholder="Empresa" required>
                </div>
                <div class="group-input">
                    <input type="tel" name="telefono" placeholder="Teléfono" required>
                    <input type="email" id="email" name="email" placeholder="Email" required>
                </div>
                <div class="box-input">
                    <textarea name="mensaje" rows="5" placeholder="Mensaje" required></textarea>
                </div>
                <p id="form-message" class="msg-form"></p>
                <button class="btn-form" type="submit">Enviar</button>
            </form>
        </div>
    </div>
</div>

<script type="module">
  const FORMS_ENDPOINT = "https://api.web3forms.com/submit";

  const form = document.getElementById("contact-form");
  const messageEl = document.getElementById("form-message");

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      messageEl.className = "msg-sending"
      messageEl.textContent = "Enviando...";

      try {
        const formData = new FormData(form);
        
        const response = await fetch(FORMS_ENDPOINT, {
          method: "POST",
          body: formData,
          headers: {
             'Accept': 'application/json' 
          }
        });

        if (response.ok) {
          messageEl.className = "msg-send"
          messageEl.textContent = "¡Formulario enviado con éxito! Gracias por contactarnos. Responderemos a tu mensaje lo antes posible.";
          form.reset();
        } else {
          const errorData = await response.json();
          const errorMessage = errorData.error || "Ocurrió un error con el servicio de formularios.";
          messageEl.className = "msg-error"
          messageEl.textContent = errorMessage;
        }
      } catch (error) {
        console.error("Error en la solicitud:", error);
        messageEl.className = "msg-error"
        messageEl.textContent = "Error de conexión. Revisa tu red.";
      }
    });
  }
</script>