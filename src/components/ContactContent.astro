---
import { getNotionTexts } from '../lib/notion';
import { notionDatabases } from '../lib/notionConfig';

const text = await getNotionTexts(notionDatabases.contacto);
---

<div class="cpragma-contact container">
    <div class="row-contact row">
        <div class="row-contact__col row-contact__col--txt">
            {text.slice().reverse().map((t) => (
                <div class="txt-top-section dark">
                    <span>{t.textTop}</span>
                </div>
                <div class="title-section dark">
                    <h2>{t.title} <span>{t.titlei}</span></h2>
                </div>
                <div class="info-contact row">
                    <div class="info-contact__col info-contact__col--address">
                        <h4>Direcci√≥n</h4>
                        <div class="address-row">
                            <div class="address-row__col">
                                <a href="https://maps.app.goo.gl/sVdsY5CaT74zfQfj6" target="_blank">
                                    <p>{t.direccionChile}</p>
                                </a>
                            </div>
                            <div class="address-row__col">
                                <a href="https://maps.app.goo.gl/rxv95NfdzT15g8dM9" target="_blank">
                                    <p>{t.direccionEspa√±a}</p>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="info-contact__col info-contact__col--contact">
                        <a href="mailto:contacto@cpragma.com">contacto@cpragma.com</a>
                        <a href="tel:56222354082">+56 2 2235 4082</a>
                    </div>
                </div>
            ))}
        </div>
        <div class="row-contact__col row-contact__col--form">
            <form id="contact-form" action="https://formspree.io/f/xdkweadq" method="POST">
                <input type="hidden" name="_subject" value="üåê üì© cpragma.com, contacto de Cliente desde" />
                <div class="box-input">
                    <input type="text" name="nombre" placeholder="Nombre" required>
                </div>
                <div class="box-input">
                    <input type="text" name="empresa" placeholder="Empresa" required>
                </div>
                <div class="group-input">
                    <input type="tel" name="telefono" placeholder="Tel√©fono" required>
                    <input type="email" id="email" name="email" placeholder="Email" required>
                </div>
                <div class="box-input">
                    <textarea name="mensaje" rows="5" placeholder="Mensaje" required></textarea>
                </div>
                <p id="form-message" class="msg-form"></p>
                <button class="btn-form" type="submit">Enviar</button>
            </form>
        </div>
    </div>
</div>

<script type="module">
  const FORMSPREE_ENDPOINT = "https://formspree.io/f/xdkweadq";

  const form = document.getElementById("contact-form");
  const messageEl = document.getElementById("form-message");

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      messageEl.style.color = "red";
      messageEl.textContent = "Enviando...";

      try {
        const formData = new FormData(form);
        
        const response = await fetch(FORMSPREE_ENDPOINT, {
          method: "POST",
          body: formData,
          headers: {
             'Accept': 'application/json' 
          }
        });

        if (response.ok) {
          messageEl.style.color = "#243F3B";
          messageEl.textContent = "Mensaje enviado correctamente ‚úÖ";
          form.reset();
        } else {
          const errorData = await response.json();
          const errorMessage = errorData.error || "Ocurri√≥ un error con el servicio de formularios.";

          messageEl.style.color = "tomato";
          messageEl.textContent = errorMessage;
        }
      } catch (error) {
        console.error("Error en la solicitud:", error);
        messageEl.style.color = "red";
        messageEl.textContent = "Error de conexi√≥n. Revisa tu red.";
      }
    });
  }
</script>